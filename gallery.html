<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>摘む人</title>
  <link href="https://fonts.googleapis.com/css2?family=BIZ+UDMincho&family=Sawarabi+Gothic&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'BIZ UDMincho', serif;
      max-width: 100%;
      margin: 0;
      padding-bottom: 80px;
    }
    h1 { text-align: center; margin-top: 1em; }
    h2 { text-align: center; margin-top: 0.2em; margin-bottom: 1em; font-family: 'Sawarabi Gothic', sans-serif; }
    #image-list { column-count: 2; column-gap: 1em; padding: 1em; }
    .image-item { break-inside: avoid; margin-bottom: 1em; }
    .image-item img { max-width: 100%; height: auto; opacity: 0; transition: opacity 1.2s ease-in; }
    .image-item img.loaded { opacity: 1; }
    .image-item .info { text-align: center; font-size: 0.9em; margin-top: 0.3em; line-height: 1.4; font-family: 'Sawarabi Gothic', sans-serif; }
    .image-item .info .title { font-weight: bold; display: block; }
    .image-item .info .nickname { display: block; color: #555; }

    /* ハンバーガー */
    .menu-btn { position: fixed; top: 15px; left: 20px; z-index: 1000; cursor: pointer; }
    .menu-btn div { width: 25px; height: 3px; background: #000; margin: 5px; transition: 0.4s; }
    .menu-btn.open div:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
    .menu-btn.open div:nth-child(2) { opacity: 0; }
    .menu-btn.open div:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
    .menu { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:999; }
    .menu a { font-size:1.5em; padding:1em; text-decoration:none; color:#000; border-top:1px solid #ccc; width:100%; text-align:center; }
    .menu a:last-child { border-bottom:1px solid #ccc; }

    /* 投稿モーダル */
    #uploadModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    #uploadModalContent { background: white; padding: 1em; border-radius: 10px; width: 90%; max-width: 400px; }
    input[type="text"], input[type="file"] { width: 100%; margin: 0.5em 0; }

    /* プラスボタン */
    #plusButton {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #8ea88f; color: white; border: none; border-radius: 50%;
      width: 60px; height: 60px; font-size: 2em; cursor: pointer;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5); box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    #status { text-align: center; margin-top: 1em; }
  </style>
</head>
<body>

<!-- ハンバーガー -->
<div class="menu-btn" id="menu-btn"><div></div><div></div><div></div></div>
<div class="menu" id="menu"><a href="index.html">HOME</a></div>

<h1>摘む人</h1>
<h2>Gallery</h2>

<div id="image-list"></div>

<!-- 投稿モーダル -->
<div id="uploadModal">
  <div id="uploadModalContent">
    <label>ニックネーム：</label><br />
    <input type="text" id="nickname" placeholder="例：みーちゃん" /><br />
    <label>タイトル：</label><br />
    <input type="text" id="title" placeholder="例：昨日の空" /><br />
    <label>画像を選択：</label><br />
    <input type="file" id="file-input" accept="image/*" /><br />
    <button id="upload-btn">アップロード</button>
  </div>
</div>

<button id="plusButton">＋</button>
<div id="status"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://hrtuyjkbchlkxzkzltak.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);
const bucketName = "images";

const fileInput = document.getElementById("file-input");
const uploadBtn = document.getElementById("upload-btn");
const statusDiv = document.getElementById("status");
const imageListDiv = document.getElementById("image-list");
const nicknameInput = document.getElementById("nickname");
const titleInput = document.getElementById("title");
const modal = document.getElementById("uploadModal");
const plusBtn = document.getElementById("plusButton");

// ハンバーガー
const menuBtn = document.getElementById("menu-btn");
const menu = document.getElementById("menu");
menuBtn.addEventListener("click", () => {
  menuBtn.classList.toggle("open");
  menu.style.display = menu.style.display === "flex" ? "none" : "flex";
});

// プラスボタンでモーダル表示
plusBtn.addEventListener("click", () => { modal.style.display = "flex"; });
function closeModalOnOutsideTap(e) { if(e.target === modal) modal.style.display = "none"; }
window.addEventListener("click", closeModalOnOutsideTap);
window.addEventListener("touchstart", closeModalOnOutsideTap);

// JPEG変換
async function convertToJpeg(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement("canvas");
        canvas.width = img.width; canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img,0,0);
        canvas.toBlob((blob)=>{
          resolve(new File([blob], file.name.replace(/\.[^/.]+$/,"")+".jpg",{type:"image/jpeg"}));
        },"image/jpeg",0.8);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// 投稿処理
uploadBtn.addEventListener("click", async () => {
  let file = fileInput.files[0];
  const nickname = nicknameInput.value.trim();
  const title = titleInput.value.trim();
  if (!file || !nickname || !title) { statusDiv.textContent = "すべての項目を入力してください。"; return; }
  if (!file.type.includes("jpeg") && !file.type.includes("jpg")) { statusDiv.textContent="変換中…"; file = await convertToJpeg(file); }
  const fileName = `${Date.now()}_${file.name}`;
  statusDiv.textContent="アップロード中…";
  const { error: uploadError } = await supabase.storage.from(bucketName).upload(fileName, file);
  if (uploadError) { statusDiv.textContent=`アップロード失敗: ${uploadError.message}`; return; }
  const { error: insertError } = await supabase.from("posts").insert([{ title, nickname, image_name:fileName }]);
  if (insertError) { statusDiv.textContent=`保存失敗: ${insertError.message}`; return; }
  modal.style.display="none"; fileInput.value=""; nicknameInput.value=""; titleInput.value=""; statusDiv.textContent="完了！";
  loadImages();
});

// 画像読み込み
async function loadImages() {
  imageListDiv.innerHTML="";
  const { data, error } = await supabase.from("posts").select("*