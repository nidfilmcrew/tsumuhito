<form id="upload-form">
  <input type="text" id="title" placeholder="タイトル" required />
  <input type="text" id="nickname" placeholder="ニックネーム" required />
  <input type="file" id="image" accept="image/*" required />
  <button type="submit">投稿</button>
</form>

<div id="image-list"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// Supabase 設定
const supabase = createClient(
  "https://YOUR-PROJECT.supabase.co",
  "YOUR-ANON-KEY"
);

// Cloudinary 設定
const cloudName = "YOUR_CLOUD_NAME";
const uploadPreset = "YOUR_UNSIGNED_PRESET";

const form = document.getElementById("upload-form");
form.addEventListener("submit", async e => {
  e.preventDefault();

  const title = document.getElementById("title").value;
  const nickname = document.getElementById("nickname").value;
  const file = document.getElementById("image").files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", uploadPreset);

  // Cloudinary にアップロード
  const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
    method: "POST",
    body: formData
  });
  const data = await res.json();
  const imageUrl = data.secure_url;

  // Supabase に投稿情報を保存
  const { error } = await supabase.from("posts").insert([{ title, nickname, image_url: imageUrl }]);
  if (error) return alert("投稿に失敗しました");
  alert("投稿成功！");

  form.reset();
  loadImages(); // 最新投稿を読み込み
});

// ギャラリー読み込み
async function loadImages() {
  const imageList = document.getElementById("image-list");
  imageList.innerHTML = "";
  const { data, error } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(6);
  if (error) return console.error(error);

  data.forEach(post => {
    const wrapper = document.createElement("div");
    wrapper.className = "image-item";

    const img = document.createElement("img");
    img.src = post.image_url;
    img.onload = () => img.classList.add("loaded");

    const info = document.createElement("div");
    info.className = "info";
    info.innerHTML = `<span class="title">${post.title}</span><span class="nickname">${post.nickname}</span>`;

    wrapper.appendChild(img);
    wrapper.appendChild(info);
    imageList.appendChild(wrapper);
  });
}

// 初回読み込み
loadImages();
</script>