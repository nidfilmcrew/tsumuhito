<script type="module">
const gallery = document.getElementById('gallery');
const uploadBtn = document.getElementById('uploadBtn');
const uploadForm = document.getElementById('uploadForm');
const overlay = document.getElementById('overlay');
const closeBtn = document.getElementById('closeBtn');
const submitBtn = document.getElementById('submitBtn');

uploadBtn.onclick = () => { uploadForm.style.display = 'block'; overlay.style.display = 'block'; }
closeBtn.onclick = () => { uploadForm.style.display = 'none'; overlay.style.display = 'none'; }
overlay.onclick = closeBtn.onclick;

submitBtn.onclick = async () => {
  const file = document.getElementById('fileInput').files[0];
  const title = document.getElementById('titleInput').value.trim();
  const name = document.getElementById('nameInput').value.trim();
  if(!file || !title || !name){ alert("全部入力してください"); return; }

  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', 'tsumuhito_unsigned'); // Unsigned preset
  const cloudName = 'dmof2f1qt'; // Mint-chanのCloud name

  try {
    const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
      method: 'POST',
      body: formData
    });
    const data = await res.json();

    if (res.ok) {
      const imageUrl = data.secure_url; // アップロードURL
      console.log("✅ アップロード成功:", imageUrl);

      // ギャラリーに追加
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<img src="${imageUrl}" alt="${title}"><p>${title}</p><p>${name}</p>`;
      gallery.prepend(div);

      // フォームリセット
      document.getElementById('fileInput').value = '';
      document.getElementById('titleInput').value = '';
      document.getElementById('nameInput').value = '';
      uploadForm.style.display = 'none';
      overlay.style.display = 'none';
    } else {
      console.error("❌ Cloudinaryエラー:", data);
      alert("Cloudinary アップロードに失敗しました: " + (data.error?.message || "不明なエラー"));
    }

  } catch(err) {
    console.error("❌ ネットワークエラー:", err);
    alert("Cloudinary への通信に失敗しました");
  }
};
</script>